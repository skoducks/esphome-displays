esphome:
  name: esp-mini-screen2
  friendly_name: esp-mini-screen2
  ## ADDED THIS MANUALLY:
  on_boot:
    then:
      - output.set_level:
          id: lcd_backlight
          level: 0.10
      - wait_until:
          api.connected:
      - delay: 2s  # Wait for sensor data to arrive
      - component.update: lcd

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "redacted"

ota:
  - platform: esphome
    password: "redacted"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Esp-Mini-Screen2"
    password: "redacted"

captive_portal:

## Everything above this point was generated by ESPHome device setup wizard, with the exception of redactions and 'esphome.on_boot' section
### FYI esp-mini-screen1 is using the same layout with different indoor sensor if you see the pic labeled as #1

spi:
  id: hspi
  clk_pin: GPIO14
  mosi_pin: GPIO13
  miso_pin: GPIO12

output:
  - platform: ledc
    pin: GPIO21
    id: lcd_backlight
    frequency: 1000Hz

# Add a number component to control screen brightness
number:
  - platform: template
    name: "Screen Brightness"
    id: screen_brightness
    min_value: 0
    max_value: 100
    step: 5
    initial_value: 10
    optimistic: true
    set_action:
      - output.set_level:
          id: lcd_backlight
          level: !lambda 'return x / 100.0;'

display:
  - platform: ili9xxx
    id: lcd
    spi_id: hspi
    model: ILI9341
    dimensions:
      width: 240
      height: 320
    rotation: 180
    cs_pin: GPIO15
    dc_pin: GPIO2
    color_order: BGR
    invert_colors: false
    spi_mode: MODE0
    color_palette: 8BIT
    data_rate: 10MHz
    auto_clear_enabled: false

# Time component for timestamp
time:
  - platform: homeassistant
    id: homeassistant_time

sensor:
 ## Outside temp/humid
  - platform: homeassistant
    id: backyard_temperature
    entity_id: sensor.backyard_temperature
  - platform: homeassistant
    id: backyard_humidity
    entity_id: sensor.backyard_humidity
 ## Define main temp/humi device here in entity_id
  - platform: homeassistant
    id: indoor_temperature
    entity_id: sensor.living_room_temperature
  - platform: homeassistant
    id: indoor_humidity
    entity_id: sensor.living_room_humidity
 ## weather sensors
  - platform: homeassistant
    id: aqi_value
    entity_id: sensor.u_s_air_quality_index
## Forecast (text)
text_sensor:
  - platform: homeassistant
    id: forecast_condition
    entity_id: sensor.forecast_condition

font:
  - file: "gfonts://Montserrat@bold"
    id: montserrat_bold_115
    size: 115
    bpp: 4
    glyphs: "0123456789°"

  - file: "fonts/RobotoCondensed-Regular.ttf"
    id: weather_icons_48
    size: 48
    bpp: 4
    extras:
      - file: "fonts/materialdesignicons-webfont.ttf"
        glyphs: [
          "\U000F0590",  # mdi-weather-cloudy
          "\U000F0591",  # mdi-weather-fog
          "\U000F0592",  # mdi-weather-hail
          "\U000F0593",  # mdi-weather-lightning
          "\U000F067E",  # mdi-weather-lightning-rainy
          "\U000F0594",  # mdi-weather-night
          "\U000F0595",  # mdi-weather-partly-cloudy
          "\U000F0596",  # mdi-weather-pouring
          "\U000F0597",  # mdi-weather-rainy
          "\U000F0598",  # mdi-weather-snowy
          "\U000F067F",  # mdi-weather-snowy-rainy
          "\U000F0599",  # mdi-weather-sunny
          "\U000F059D",  # mdi-weather-windy
          "\U000F059E",  # mdi-weather-windy-variant\
        ]

lvgl:
  buffer_size: 25%

# Dark background style
  style_definitions:
    - id: dark_bg
      bg_color: 0x0a0a0a
      bg_opa: COVER
      text_color: 0xFFFFFF

  pages:
    - id: main_page
      bg_color: 0x0a0a0a
      scrollbar_mode: "off"
      widgets:
## CLOCK AND DATE
        - label:
            id: date_display
            text: "-"
            align: TOP_MID
            x: 0
            y: 5
            text_font: montserrat_24
            text_color: 0xFFFFFF
        - label:
            id: time_display
            text: "--:--"
            align: TOP_MID
            x: 0
            y: 28
            text_font: montserrat_48
            text_color: 0x00FF00
## PRIMARY T/H
        - label:
            id: indoor_temperature_label
            text: "T"
            align: TOP_MID
            x: 0
            y: 78
            text_font: montserrat_bold_115
        - label:
            id: indoor_humidity_label
            text: "H"
            align: TOP_LEFT
            x: 120
            y: 195
            text_font: montserrat_28
## Outdoor data (bottom)
        - label:
            text: "Outside"
            align: TOP_LEFT
            x: 5
            y: 239
            text_font: montserrat_24
            text_color: 0xFFFFFF
    ## HORZ BORDER
        - obj:
            align: TOP_LEFT
            x: 5
            y: 263
            width: 100
            height: 2
            bg_color: 0xBFBFBF
            border_width: 0 
        - label:
            id: forecast_icon
            text: "?"
            align: TOP_LEFT
            x: 6
            y: 269
            text_font: weather_icons_48
        - label:
            id: backyard_temperature_label
            text: "T"
            align: TOP_MID
            x: -15
            y: 267
            text_font: montserrat_44
            text_color: 0xFFFFFF
        - label:
            id: aqi_label
            text: "AQI"
            align: TOP_MID
            x: 72
            y: 271
            text_font: montserrat_22
        - label:
            id: backyard_humidity_label
            text: "H"
            align: TOP_MID
            x: 72
            y: 295
            text_font: montserrat_20

interval:
  - interval: 10s
    then:
    # Update time & date
      - lvgl.label.update:
          id: time_display
          text: !lambda |-
            return id(homeassistant_time).now().strftime("%I:%M %p").c_str();
      - lvgl.label.update:
          id: date_display
          text: !lambda |-
            return id(homeassistant_time).now().strftime("%a, %b %d").c_str();
      ## Physical thermo/hygro - OUTDOOR
      - lvgl.label.update:
          id: backyard_temperature_label
          text: !lambda |-
            return str_sprintf("%.0f°", id(backyard_temperature).state);
      - lvgl.label.update:
          id: backyard_humidity_label
          text: !lambda |-
            return str_sprintf("H: %.0f%%", id(backyard_humidity).state);
          text_color: !lambda |-
            float hum = id(backyard_humidity).state;
            if (hum < 30) return lv_color_hex(0xD2691E);  // chocolate brown - very dry
            if (hum < 45) return lv_color_hex(0xDEB887);  // burlywood - dry
            if (hum < 60) return lv_color_hex(0x87CEEB);  // sky blue - normal
            if (hum < 75) return lv_color_hex(0x4682B4);  // steel blue - wet
            return lv_color_hex(0x1E90FF);                // dodger blue - very wet
      ## Physical thermo/hygro - INDOOR
      - lvgl.label.update:
          id: indoor_temperature_label
          text: !lambda |-
            return str_sprintf("%.0f°", id(indoor_temperature).state);
          text_color: !lambda |-
            float temp = id(indoor_temperature).state;
            if (temp < 66) return lv_color_hex(0x6666FF);    // blue
            if (temp < 69) return lv_color_hex(0x9999FF);    // blue-gray
            if (temp < 72) return lv_color_hex(0xFFFFFF);    // white
            if (temp < 75) return lv_color_hex(0xFFC266);    // light orange
            return lv_color_hex(0xFF6666);                   // light red
      - lvgl.label.update:
          id: indoor_humidity_label
          text: !lambda |-
            return str_sprintf("H: %.0f%%", id(indoor_humidity).state);
          text_color: !lambda |-
            float hum = id(indoor_humidity).state;
            if (hum < 30) return lv_color_hex(0xD2691E);  // chocolate brown - very dry
            if (hum < 45) return lv_color_hex(0xDEB887);  // burlywood - dry
            if (hum < 60) return lv_color_hex(0x87CEEB);  // sky blue - normal
            if (hum < 75) return lv_color_hex(0x4682B4);  // steel blue - wet
            return lv_color_hex(0x1E90FF);                // dodger blue - very wet

## OUTSIDE DATA
      - lvgl.label.update:
          id: aqi_label
          text: !lambda |-
            // Set color based on AQI value
            auto label = id(aqi_label);
            float aqi = id(aqi_value).state;
            
            if (aqi <= 50) {
              lv_obj_set_style_text_color(label, lv_color_hex(0x00E400), 0);  // Good - Green
            } else if (aqi <= 100) {
              lv_obj_set_style_text_color(label, lv_color_hex(0xFFD700), 0);  // Moderate - Gold
            } else if (aqi <= 150) {
              lv_obj_set_style_text_color(label, lv_color_hex(0xFF8C00), 0);  // Unhealthy for Sensitive - Orange
            } else if (aqi <= 200) {
              lv_obj_set_style_text_color(label, lv_color_hex(0xFF4444), 0);  // Unhealthy - Red
            } else if (aqi <= 300) {
              lv_obj_set_style_text_color(label, lv_color_hex(0xBB44FF), 0);  // Very Unhealthy - Purple
            } else {
              lv_obj_set_style_text_color(label, lv_color_hex(0xCC2244), 0);  // Hazardous - Maroon
            }
            
            return str_sprintf("AQI: %.0f", aqi);
      - lvgl.label.update:
          id: forecast_icon
          text: !lambda |-
            std::string condition = id(forecast_condition).state;
            auto label = id(forecast_icon);
            
            if (condition == "sunny") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xFFD700), 0);  // Gold
              return "\U000F0599";
            } else if (condition == "clear-night") {
              lv_obj_set_style_text_color(label, lv_color_hex(0x87CEEB), 0);  // Sky blue
              return "\U000F0594";
            } else if (condition == "partlycloudy") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xAAAAAA), 0);  // Gray
              return "\U000F0595";
            } else if (condition == "cloudy") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xAAAAAA), 0);  // Gray
              return "\U000F0590";
            } else if (condition == "rainy") {
              lv_obj_set_style_text_color(label, lv_color_hex(0x4A90E2), 0);  // Blue
              return "\U000F0597";
            } else if (condition == "pouring") {
              lv_obj_set_style_text_color(label, lv_color_hex(0x4A90E2), 0);  // Blue
              return "\U000F0596";
            } else if (condition == "snowy") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xE0F7FF), 0);  // Light blue/white
              return "\U000F0598";
            } else if (condition == "snowy-rainy") {
              lv_obj_set_style_text_color(label, lv_color_hex(0x87CEEB), 0);  // Sky blue
              return "\U000F067F";
            } else if (condition == "lightning") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xFFFF00), 0);  // Yellow
              return "\U000F0593";
            } else if (condition == "lightning-rainy") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xFFFF00), 0);  // Yellow
              return "\U000F067E";
            } else if (condition == "fog") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xCCCCCC), 0);  // Light gray
              return "\U000F0591";
            } else if (condition == "hail") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xE0F7FF), 0);  // Light blue/white
              return "\U000F0592";
            } else if (condition == "windy") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xAAAAAA), 0);  // Gray
              return "\U000F059D";
            } else if (condition == "windy-variant") {
              lv_obj_set_style_text_color(label, lv_color_hex(0xAAAAAA), 0);  // Gray
              return "\U000F059E";
            } else {
              lv_obj_set_style_text_color(label, lv_color_hex(0xFFFFFF), 0);  // White
              return "--";
            }    
